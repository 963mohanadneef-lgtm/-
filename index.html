<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menu + Admin (Sheets/Drive)</title>
  <style>
    :root{font-family:system-ui,Segoe UI,Tahoma,Arial}
    body{margin:0;background:#0b0f14;color:#e8eef6}
    header{position:sticky;top:0;background:rgba(10,14,20,.9);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.08);padding:14px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:#47ffa3;box-shadow:0 0 18px rgba(71,255,163,.35)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#e8eef6;padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:#47ffa3;color:#04110a;border-color:#47ffa3;font-weight:700}
    .btn.danger{background:rgba(255,70,70,.15);border-color:rgba(255,70,70,.35)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{grid-column:span 4;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);border-radius:16px;overflow:hidden}
    .card img{width:100%;height:220px;object-fit:cover;background:#0c121a}
    .card .p{padding:12px}
    .muted{opacity:.7;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .panel{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px}
    input,textarea,select{width:100%;box-sizing:border-box;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);color:#e8eef6;padding:10px 12px;border-radius:12px;outline:none}
    textarea{min-height:90px;resize:vertical}
    .col6{grid-column:span 6}
    .col12{grid-column:span 12}
    .hide{display:none}
    .toast{position:fixed;bottom:16px;left:16px;right:16px;max-width:520px;margin:0 auto;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.14);padding:12px 14px;border-radius:14px;backdrop-filter:blur(8px);display:none}
    .toast.show{display:block}
    @media (max-width:900px){.card{grid-column:span 6}}
    @media (max-width:600px){.card{grid-column:span 12}}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="dot"></div>
    <div>
      <div style="font-weight:800">Menu (Sheets + Drive)</div>
      <div class="muted">رفع صورة → Drive → رابط عام → يظهر بالموقع</div>
    </div>
  </div>
  <div class="tabs">
    <button class="btn primary" id="tabPublic">عرض المنيو</button>
    <button class="btn" id="tabAdmin">لوحة الإدارة</button>
    <button class="btn" id="btnRefresh">تحديث</button>
  </div>
</header>

<div class="wrap">
  <!-- PUBLIC -->
  <section id="publicView">
    <div class="row" style="margin:10px 0 14px">
      <select id="filterCategory" style="max-width:260px">
        <option value="">كل التصنيفات</option>
      </select>
      <label class="muted">يعرض فقط العناصر المتاحة (available=true)</label>
    </div>

    <div class="grid" id="cards"></div>
  </section>

  <!-- ADMIN -->
  <section id="adminView" class="hide">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:800">إضافة / تعديل عنصر</div>
        <div class="row">
          <button class="btn" id="btnNew">عنصر جديد</button>
          <button class="btn danger" id="btnDelete" disabled>حذف</button>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="col6">
          <label class="muted">Category</label>
          <input id="fCategory" placeholder="مثال: Burgers" />
        </div>
        <div class="col6">
          <label class="muted">Item ID</label>
          <input id="fItemId" placeholder="مثال: B01" />
        </div>

        <div class="col12">
          <label class="muted">Name</label>
          <input id="fName" placeholder="اسم الوجبة" />
        </div>

        <div class="col12">
          <label class="muted">Description</label>
          <textarea id="fDesc" placeholder="وصف مختصر"></textarea>
        </div>

        <div class="col6">
          <label class="muted">Price</label>
          <input id="fPrice" type="number" step="0.01" />
        </div>
        <div class="col6">
          <label class="muted">Currency</label>
          <input id="fCurrency" value="QAR" />
        </div>

        <div class="col12">
          <label class="muted">Image</label>
          <div class="row">
            <input id="fImageFile" type="file" accept="image/*" />
            <button class="btn" id="btnUpload">رفع الصورة</button>
          </div>
          <div class="row" style="margin-top:10px">
            <input id="fImageUrl" placeholder="أو ضع رابط صورة يدويًا" />
          </div>
          <div class="row" style="margin-top:10px">
            <img id="imgPreview" alt="" style="width:220px;height:140px;object-fit:cover;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:#0c121a;display:none">
          </div>
        </div>

        <div class="col6">
          <label class="muted">Available</label>
          <select id="fAvailable">
            <option value="true">TRUE</option>
            <option value="false">FALSE</option>
          </select>
        </div>
        <div class="col6">
          <label class="muted">Featured</label>
          <select id="fFeatured">
            <option value="false">FALSE</option>
            <option value="true">TRUE</option>
          </select>
        </div>

        <div class="col6">
          <label class="muted">Sort</label>
          <input id="fSort" type="number" />
        </div>
        <div class="col6">
          <label class="muted">Row Index (للتعديل)</label>
          <input id="fRowIndex" type="number" placeholder="يطلع تلقائي" disabled />
        </div>

        <div class="col12">
          <div class="row" style="justify-content:space-between;margin-top:8px">
            <button class="btn primary" id="btnSave">حفظ</button>
            <span class="muted" id="status"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:14px">
      <div style="font-weight:800;margin-bottom:10px">العناصر الحالية (اضغط للتعديل)</div>
      <div id="adminList" class="grid"></div>
    </div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script>
  // ضع رابط /exec هنا
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGKBzBohlxNjr1GxRiR-HBwVGcMur208NWU0UKTBkoWf6g6HnJFNg3EWmiVaQ-x2uY/exec";

  let allItems = [];
  let currentEdit = null;

  const el = (id) => document.getElementById(id);
  const toast = (msg) => {
    const t = el("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2800);
  };

  function setStatus(msg){ el("status").textContent = msg || ""; }

  async function apiPost(payload) {
    // مهم جداً: لا نرسل Content-Type لتجنب Preflight
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(payload),
      redirect: "follow"
    });
    const data = await res.json();
    if (data && data.error) throw new Error(data.error);
    return data;
  }

  async function loadItems() {
    setStatus("جارِ التحميل...");
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();
    allItems = Array.isArray(data) ? data : [];
    renderPublic();
    renderAdminList();
    fillCategories();
    setStatus("");
  }

  function fillCategories(){
    const cats = [...new Set(allItems.map(x=>x.category).filter(Boolean))].sort();
    const sel = el("filterCategory");
    const current = sel.value;
    sel.innerHTML = `<option value="">كل التصنيفات</option>` + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    sel.value = current;
  }

  function renderPublic(){
    const cat = el("filterCategory").value;
    const cards = el("cards");

    const items = allItems
      .filter(x => x.available === true)
      .filter(x => !cat || x.category === cat)
      .sort((a,b)=>(a.sort||0)-(b.sort||0));

    cards.innerHTML = items.map(item => {
      const img = item.image_url || "";
      return `
        <div class="card">
          <img src="${escapeAttr(img)}" alt="${escapeAttr(item.name||"")}" onerror="this.style.opacity=.15" />
          <div class="p">
            <div style="font-weight:800">${escapeHtml(item.name||"")}</div>
            <div class="muted" style="margin:6px 0">${escapeHtml(item.description||"")}</div>
            <div class="row" style="justify-content:space-between">
              <div style="font-weight:800">${Number(item.price||0).toFixed(2)} ${escapeHtml(item.currency||"")}</div>
              <div class="muted">${escapeHtml(item.category||"")}</div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    if (!items.length) {
      cards.innerHTML = `<div class="panel col12" style="grid-column:span 12">لا يوجد عناصر متاحة للعرض.</div>`;
    }
  }

  function renderAdminList(){
    const wrap = el("adminList");
    const items = [...allItems].sort((a,b)=> (a.rowIndex||0)-(b.rowIndex||0));
    wrap.innerHTML = items.map(item => {
      const img = item.image_url || "";
      return `
        <div class="card" style="cursor:pointer" onclick="window.__edit(${item.rowIndex})">
          <img src="${escapeAttr(img)}" alt="" onerror="this.style.opacity=.15" />
          <div class="p">
            <div style="font-weight:800">${escapeHtml(item.name||"")}</div>
            <div class="muted">Row: ${item.rowIndex} • ${escapeHtml(item.category||"")}</div>
          </div>
        </div>
      `;
    }).join("");

    window.__edit = (rowIndex) => {
      const item = allItems.find(x=>x.rowIndex===rowIndex);
      if (!item) return;
      loadForm(item);
      toast("تم تحميل العنصر للتعديل");
    };
  }

  function clearForm(){
    currentEdit = null;
    el("fCategory").value = "";
    el("fItemId").value = "";
    el("fName").value = "";
    el("fDesc").value = "";
    el("fPrice").value = "";
    el("fCurrency").value = "QAR";
    el("fImageFile").value = "";
    el("fImageUrl").value = "";
    el("fAvailable").value = "true";
    el("fFeatured").value = "false";
    el("fSort").value = "";
    el("fRowIndex").value = "";
    el("imgPreview").style.display = "none";
    el("btnDelete").disabled = true;
  }

  function loadForm(item){
    currentEdit = item;
    el("fCategory").value = item.category || "";
    el("fItemId").value = item.item_id || "";
    el("fName").value = item.name || "";
    el("fDesc").value = item.description || "";
    el("fPrice").value = item.price ?? "";
    el("fCurrency").value = item.currency || "QAR";
    el("fImageUrl").value = item.image_url || "";
    el("fAvailable").value = item.available ? "true" : "false";
    el("fFeatured").value = item.featured ? "true" : "false";
    el("fSort").value = item.sort ?? "";
    el("fRowIndex").value = item.rowIndex || "";
    showPreview(item.image_url || "");
    el("btnDelete").disabled = !item.rowIndex;
  }

  function getFormData(){
    return {
      category: el("fCategory").value.trim(),
      item_id: el("fItemId").value.trim(),
      name: el("fName").value.trim(),
      description: el("fDesc").value.trim(),
      price: Number(el("fPrice").value || 0),
      currency: el("fCurrency").value.trim() || "QAR",
      image_url: el("fImageUrl").value.trim(),
      available: el("fAvailable").value === "true",
      featured: el("fFeatured").value === "true",
      sort: Number(el("fSort").value || 0),
      rowIndex: currentEdit?.rowIndex
    };
  }

  function showPreview(url){
    const img = el("imgPreview");
    if (!url) { img.style.display="none"; img.src=""; return; }
    img.src = url;
    img.style.display = "block";
  }

  async function uploadImage(){
    const file = el("fImageFile").files[0];
    if (!file) return toast("اختر صورة أولاً");

    setStatus("جارِ رفع الصورة إلى Drive...");
    const base64 = await fileToDataURL(file);

    try{
      const out = await apiPost({
        action: "uploadImage",
        imageData: base64,
        fileName: file.name
      });

      // استخدم الرابط الرئيسي
      el("fImageUrl").value = out.imageUrl;
      showPreview(out.imageUrl);
      toast("✅ تم رفع الصورة وتحويلها لرابط عام");
    }catch(err){
      toast("❌ " + err.message);
    }finally{
      setStatus("");
    }
  }

  async function saveItem(){
    const item = getFormData();

    if (!item.name) return toast("اكتب اسم العنصر");
    if (!item.category) return toast("اكتب التصنيف");
    if (!item.image_url) return toast("ارفع صورة أو ضع رابط");

    setStatus("جارِ الحفظ...");
    try{
      const action = item.rowIndex ? "update" : "add";
      const payload = { action, item };
      await apiPost(payload);
      toast("✅ تم الحفظ");
      await loadItems();
      // بعد إعادة التحميل حاول إعادة فتح العنصر إذا كان تعديل
      if (item.rowIndex) {
        const updated = allItems.find(x=>x.rowIndex===item.rowIndex);
        if (updated) loadForm(updated);
      } else {
        clearForm();
      }
    }catch(err){
      toast("❌ " + err.message);
    }finally{
      setStatus("");
    }
  }

  async function deleteItem(){
    if (!currentEdit?.rowIndex) return;
    if (!confirm("متأكد تريد الحذف؟")) return;

    setStatus("جارِ الحذف...");
    try{
      await apiPost({ action:"delete", rowIndex: Number(currentEdit.rowIndex) });
      toast("✅ تم الحذف");
      clearForm();
      await loadItems();
    }catch(err){
      toast("❌ " + err.message);
    }finally{
      setStatus("");
    }
  }

  function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

  // Tabs
  el("tabPublic").onclick = ()=>{
    el("publicView").classList.remove("hide");
    el("adminView").classList.add("hide");
    el("tabPublic").classList.add("primary");
    el("tabAdmin").classList.remove("primary");
  };
  el("tabAdmin").onclick = ()=>{
    el("adminView").classList.remove("hide");
    el("publicView").classList.add("hide");
    el("tabAdmin").classList.add("primary");
    el("tabPublic").classList.remove("primary");
  };

  // Actions
  el("btnRefresh").onclick = loadItems;
  el("btnUpload").onclick = uploadImage;
  el("btnSave").onclick = saveItem;
  el("btnNew").onclick = ()=>{ clearForm(); toast("جاهز لإضافة عنصر جديد"); };
  el("btnDelete").onclick = deleteItem;
  el("filterCategory").onchange = renderPublic;
  el("fImageUrl").addEventListener("input", (e)=> showPreview(e.target.value.trim()));

  // init
  clearForm();
  loadItems().catch(err=>toast("❌ " + err.message));
</script>
</body>
</html>

